# PLC 可视化查询工具 V3.0

## 📋 项目简介

这是一个专为西门子S7系列PLC设计的可视化监控和查询工具，提供实时数据读取、历史数据查询、报警监控等功能。该工具采用Python开发，具有友好的图形用户界面，支持多PLC并发监控。

## 🚀 主要功能

### 核心功能
- **多PLC并发监控**: 支持同时监控多个PLC设备，高并发查询
- **实时数据读取**: 支持多种数据类型（bool、byte、word、dword、int、dint、real、string）
- **历史数据查询**: 基于时间范围和地址过滤的历史数据检索
- **报警监控**: 毫秒级地址值变化检测和报警记录
- **数据持久化**: 支持SQLite数据库存储和日志文件记录

### 界面功能
- **三标签页设计**: 查询结果、报警监控、历史查询
- **分页显示**: 支持大量数据的分页浏览
- **地址映射**: 支持PLC地址与中文名称的映射配置
- **配置管理**: 可视化的PLC配置添加、编辑、导入导出

## 📁 项目结构

```
SiemensPlc_ControlTool/
├── PLCAddressMonitoring.py    # 主程序文件（V3.0版本）
├── ReadCode.py                # 主程序文件（V2.6.1版本）
├── read.py                    # cx_Freeze打包配置文件
├── address_mapping.json       # PLC地址映射配置文件
├── configs.json              # PLC配置参数文件（运行时生成）
├── plc_query_data.db         # SQLite数据库文件（运行时生成）
├── plc_query.log             # 日志文件（运行时生成）
├── alarm_history.jsonl       # 报警历史文件（运行时生成）
├── logs/                     # 日志目录
│   ├── plc_query.log
│   └── plc_query.log.2025-03-21
└── plcread/                  # 包目录
    └── __init__.py
```

## 🛠️ 技术栈

- **编程语言**: Python 3.x
- **GUI框架**: Tkinter + ttk
- **PLC通信**: python-snap7
- **数据库**: SQLite3
- **日期控件**: tkcalendar
- **打包工具**: cx_Freeze

## 📦 安装依赖

```bash
# 安装必需的Python包
pip install python-snap7
pip install tkcalendar
pip install cx_Freeze  # 用于打包exe文件
```

## 🚀 快速开始

### 1. 运行程序
```bash
# 直接运行Python脚本
python PLCAddressMonitoring.py

# 或者运行另一个版本
python ReadCode.py
```

### 2. 配置PLC连接
1. 启动程序后，点击"配置管理" → "新增配置"
2. 填写PLC配置信息：
   - **PLC地址**: PLC的IP地址（如：192.168.0.1）
   - **DB块**: 数据块号（如：1）
   - **起始地址**: 起始字节地址（如：0）
   - **数据类型**: 选择对应的数据类型
   - **地址格式前缀**: 选择地址显示格式

### 3. 配置地址映射
编辑 `address_mapping.json` 文件，添加PLC地址与中文名称的映射：
```json
{
    "DB1.DBX0.0": "机器启动信号",
    "DB1.DBD4": "反应釜A液位 (Real)",
    "DB2.DBW10": "传送带速度设定 (Int)"
}
```

### 4. 开始监控
1. 选择配置或勾选"查询所有"
2. 选择"持续查询"进行连续监控
3. 点击"查询"按钮开始数据读取

## 📊 功能详解

### 查询结果标签页
- 显示实时读取的PLC数据
- 支持分页浏览（每页50条记录）
- 显示配置名称、时间戳、地址、地址名称、数据类型、数值

### 报警监控标签页
- 监控地址值变化并记录报警
- 显示变化前后的数值
- 支持报警历史持久化存储

### 历史查询标签页
- 按时间范围查询历史数据
- 支持地址/名称模糊过滤
- 基于SQLite数据库的高效查询

## ⚙️ 配置说明

### 数据类型支持
- **bool**: 布尔值，地址格式为 `<byte>.<bit>`（如：0.1）
- **byte**: 字节，1字节
- **word**: 字，2字节
- **dword**: 双字，4字节
- **int**: 整数，2字节
- **dint**: 双整数，4字节
- **real**: 浮点数，4字节
- **string**: 字符串，可变长度

### 地址格式前缀
- **DBX**: 位地址（用于bool类型）
- **DBB**: 字节地址
- **DBW**: 字地址
- **DBD**: 双字地址

### String类型特殊说明
1. 确保PLC中的DB块**未**勾选"优化块访问"
2. 数据类型设置为`string`
3. 地址格式前缀通常设置为`DBB`
4. 起始地址设置为S7 String结构开始的字节偏移量
5. 字符串长度设置为PLC中定义的String的数据区长度

## 🔧 高级功能

### 配置导入导出
- 支持JSON格式的配置导入导出
- 便于配置的备份和迁移

### 日志管理
- 详细的运行日志记录
- 支持日志文件轮转
- UTF-8编码，支持中文显示

### 数据库管理
- 自动创建SQLite数据库
- 支持数据保留期设置（默认7天）
- 自动清理过期数据

## 📝 使用注意事项

1. **网络连接**: 确保PC与PLC在同一网段，网络连接正常
2. **PLC设置**: 对于S7-1200/1500，需要禁用DB块的"优化块访问"
3. **防火墙**: 确保防火墙允许PLC通信端口
4. **权限**: 确保程序有足够的文件读写权限

## 🐛 故障排除

### 常见问题
1. **连接失败**: 检查PLC地址、网络连接、防火墙设置
2. **读取错误**: 检查DB块号、地址范围、数据类型设置
3. **String读取失败**: 确认DB块未优化，检查字符串长度设置

### 日志查看
- 程序运行日志保存在 `plc_query.log`
- 可通过菜单"查看" → "查看日志文件"直接打开
- 日志采用UTF-8编码，请使用支持此编码的工具查看

## 📞 技术支持

如有问题，请联系开发团队并附上：
- 问题截图
- 详细情况说明
- 相关日志信息

## 📄 版本历史

- **V3.0**: 当前版本，支持多PLC并发监控、数据持久化、历史查询
- **V2.6.1**: 代码格式化、日志编码修正、String调试功能
- **V2.6**: 地址格式解耦、String类型支持

## 📜 许可证

本项目仅供内部使用，请勿外传。

---

**开发团队**: 袁锦浩  
**最后更新**: 2025年3月 